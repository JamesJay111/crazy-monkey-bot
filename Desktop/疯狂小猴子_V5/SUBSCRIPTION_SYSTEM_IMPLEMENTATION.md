# 策略频道/主题流订阅系统 - 实现文档

## 📋 实现概览

在庄家轧空模块基础上，新增"策略频道/主题流订阅系统"，让用户可以只接收自己关心的那一类结构信号。

⚠️ 这是"信息过滤系统"，不是交易策略系统
⚠️ 不改变原有功能，只是新增订阅层

## 🎯 设计目标

- ✅ 用户不用理解底层逻辑
- ✅ 用"人能理解的主题"来订阅
- ✅ 默认不订阅任何频道（避免骚扰）
- ✅ 推送只来自 Prompt D 的事件触发

## 📁 新增/修改的文件清单

### 新增文件
1. **`src/services/strategyChannelEngine.service.ts`** - 频道匹配引擎
2. **`src/services/subscriptionService.service.ts`** - 订阅管理服务
3. **`src/routes/subscription.ts`** - 订阅管理UI路由

### 修改文件
1. **`src/services/squeezePush.service.ts`** - 集成频道匹配和订阅分发
2. **`src/routes/start.ts`** - 添加订阅按钮到主菜单
3. **`src/bot/index.ts`** - 初始化订阅服务并注册路由
4. **`db/init.sql`** - 通过代码自动添加 metadata 列（如果不存在）

## 🔧 核心功能说明

### 1. 预置频道（G1.1）

| Channel ID | 展示名 | 含义 |
|------------|--------|------|
| strong_reversal | 强结构反转 | 4h 内出现强反转（空→多 / 多→空） |
| high_risk_squeeze | 高风险挤压 | 风险等级 ≥ 🟠 高 |
| high_confidence | 高可信结构 | 结构可信度 ⭐⭐⭐ |
| long_bias_accel | 多头加速 | 无反转，但多军开仓明显 |
| short_bias_accel | 空头加速 | 无反转，但空军开仓明显 |

### 2. 频道匹配规则（G2.2）

- **strong_reversal**: reversalStrength == strong
- **high_risk_squeeze**: risk.riskLevel == "high" 或 "extreme"
- **high_confidence**: risk.confidenceStars == 3
- **long_bias_accel**: reversal == none && positionBias == long_stronger
- **short_bias_accel**: reversal == none && positionBias == short_stronger

一个事件可以同时命中多个频道。

### 3. 用户订阅模型（G3）

- 一个用户可订阅 0–N 个频道
- 默认 channels = []
- 存储在数据库 users 表的 metadata 字段（JSON格式）

### 4. 推送分发逻辑（G4）

1. 计算事件命中的 matchedChannels
2. 查询所有用户的订阅
3. 仅当用户订阅的频道 ∩ matchedChannels ≠ 空，才推送
4. 同一事件对同一用户只推送一次（即使命中多个频道）

### 5. 推送文案（G5）

在原有推送模板基础上，增加频道提示：

```
🧨 结构异动｜BTC
空转多（强）

命中频道：强结构反转 · 高可信结构
风险等级：🔴 极高
结构可信度：⭐⭐⭐

- 结构变化：空→多
...
```

### 6. 订阅管理UI（G6.1）

**新增按钮：** `📡 结构订阅`

**功能：**
- 展示所有可用频道
- 显示当前订阅状态（✅/☐）
- 点击即切换订阅状态
- 简短确认反馈

### 7. 防骚扰规则（G7）

- 单用户4h内最多3条推送
- 若超过，按优先级丢弃：
  1. 强结构反转
  2. 高风险挤压
  3. 高可信结构
  4. 其他

## 🧪 自测用例

| 测试场景 | 期望结果 |
|----------|----------|
| 用户未订阅任何频道 | 0 推送 |
| 用户仅订阅「强结构反转」+ 弱反转 | 不推 |
| 用户仅订阅「强结构反转」+ 强反转 | 推 |
| 同一事件命中多个频道 | 只推 1 条 |
| 连续事件 | 不超过限额（4h内3条） |

## ✅ 验收标准

- ✅ 用户未订阅任何频道 → 0 推送
- ✅ 只有订阅了对应频道的用户收到推送
- ✅ 同一事件对同一用户只推送一次
- ✅ 防骚扰规则生效（4h内最多3条）
- ✅ 订阅UI正常工作
- ✅ 不改变原有功能

## 💡 产品层完成度

现在系统已经拥有：

1. ✅ **结构扫描引擎** - 后台定时扫描Binance合约
2. ✅ **事件驱动推送** - 结构异动自动推送
3. ✅ **一句话标签系统** - 极低认知成本
4. ✅ **风险等级 & 可信度抽象** - 注意力管理工具
5. ✅ **用户可控的主题订阅系统** - 信息过滤

**这已经是专业交易工具 / 情报系统的完整形态，而不是普通 TG Bot。**

